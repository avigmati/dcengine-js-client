!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.dcengine=t():e.dcengine=t()}(this,function(){return function(e){function t(o){if(n[o])return n[o].exports;var i=n[o]={i:o,l:!1,exports:{}};return e[o].call(i.exports,i,i.exports,t),i.l=!0,i.exports}var n={};return t.m=e,t.c=n,t.i=function(e){return e},t.d=function(e,n,o){t.o(e,n)||Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:o})},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=0)}([function(e,t,n){"use strict";function o(e,t){this.error="DCEngine server error: "+e,this.action_obj=t}function i(e){this.error="DCEngine client error: "+e}function r(e,t){this.error="DCEngine request error: "+e,this.error_data=t}function s(e){for(let t of l)if(t.name===e)return t.consumer}function c(e){l.push({name:e.prototype.constructor.name,consumer:e.prototype.consumer})}function u(e,t,n,o){let i=e;if("function"==typeof i)return i(o);for(let i of t)if(e.hasOwnProperty(i)&&t.length)return t.splice(t.indexOf(i),1),u(e[i],t,n,o);return new Promise((e,t)=>{t(n+" not implemented.")})}function a(e,t,n){t()?e():setTimeout(function(){a(e,t,n)},n)}function f(e,t){return new Promise((n,o)=>{a(()=>{u(y.__proto__,e.split("."),e,t).then(function(e){n(e)},function(e){o(e)})},()=>d,500)})}Object.defineProperty(t,"__esModule",{value:!0}),t.consumer=c,t.dce=f;let d=!1;const h="undefined"!=typeof DCE_DEBUG&&DCE_DEBUG;let p;if("undefined"==typeof DCE_SOCKET_URL)throw new i("DCE_SOCKET_URL undefined.");p=DCE_SOCKET_URL;let l=[];class _{constructor(e,t){this.debug=t,this.socket=new WebSocket(e),this.socketQueueId=0,this.socketQueue={},this.consumer_handler=null,this.init_handler=null,this.socket.onmessage=(e=>{let t={};try{t=JSON.parse(e.data)}catch(e){throw new i("response json parse error: "+e)}if(void 0!==t.cmd_id&&"function"==typeof this.socketQueue["i_"+t.cmd_id]){let e=this.socketQueue["i_"+t.cmd_id];e(t),delete this.socketQueue["i_"+t.cmd_id]}else switch("service"===t.msg_type){case!0:if("error"===t.status)throw new o(t.error,t.error_data);this.init_handler(t.data.actions,t.data.version);break;case!1:this.consumer_handler(t)}}),this.socket.onopen=(e=>{this.debug&&console.log("Socket open.")}),this.socket.onclose=(()=>{this.debug&&console.log("Socket close.")})}send_rpc(e,t){this.waitForConnection(()=>{void 0!==t&&(this.socketQueueId++,this.socketQueue["i_"+this.socketQueueId]=t,e.cmd_id=this.socketQueueId,this.socket.send(JSON.stringify(e)))},1e3)}send_consumer(e){this.waitForConnection(()=>{Array.isArray(e.data.callbacks)?e.callbacks=e.data.callbacks:e.callbacks=[];this.socket.send(JSON.stringify(e))},1e3)}waitForConnection(e,t){if(1===this.socket.readyState)e();else{let n=this;setTimeout(function(){n.waitForConnection(e,t)},t)}}call(e,t,n){let o=this;return"rpc"===t?new Promise((t,i)=>{o.send_rpc({action:e,data:n},e=>{"error"!==e.status?t(e.data):i({error:e.error,data:e.error_data})})}):new Promise((t,i)=>{t(o.send_consumer({action:e,data:n}))})}set_consumer_handler(e){this.consumer_handler=e}set_init_handler(e){this.init_handler=e}}class m{constructor(e,t){this.debug=t,this.init=this.init.bind(this),this.call=this.call.bind(this),this.base_consumer=this.base_consumer.bind(this),this.core=new _(e,t),this.core.set_consumer_handler(this.base_consumer),this.core.set_init_handler(this.init)}static create_action_proto(e,t,n){let o=3===arguments.length&&t.pop();for(let n in t)e=e[t[n]]=e[t[n]]||{};return o&&(e=e[o]=n),e}static get_action(e,t){let n=e;if("function"==typeof n)return n;for(let n of t)if(e.hasOwnProperty(n)&&t.length)return t.splice(t.indexOf(n),1),m.get_action(e[n],t)}init(e,t){const n=e.map(e=>{let t=this;let n=function(...n){return t.call(e.name,...n)};n.prototype._dce_name=e.name;n.prototype._dce_type=e.type;m.create_action_proto(m.prototype,e.name.split("."),n);return"["+e.type.toUpperCase()+"] "+e.name});d=!0,this.debug&&console.log("DCEngine v"+t+" initialized with actions: ",n)}call(e,...t){let n={};for(let e of t)e===Object(e)&&"function"!=typeof e&&(n=e);const o=m.get_action(this.__proto__,e.split("."));return this.core.call(o.prototype._dce_name,o.prototype._dce_type,n)}base_consumer(e){switch(Array.isArray(e.consumers)&&e.consumers.length>0){case!0:for(let t of e.consumers){let n=s(t);void 0!==n&&n(e.data,e.error,e.error_data)}break;case!1:if("error"===e.status)throw new r(e.error,e.error_data);console.log("DCEngine.base_consumer:",e)}}}const y=new m(p,h)}])});